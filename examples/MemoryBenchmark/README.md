# Memory Benchmark

The `MemoryBenchmark.ino` was compiled with each `FEATURE_*` and the flash
memory and static RAM sizes were recorded. The `FEATURE_BASELINE` selection is
the baseline, and its memory usage  numbers are subtracted from the subsequent
`FEATURE_*` memory usage.

**NOTE**: This file was auto-generated using `make README.md`. DO NOT EDIT.

**Version**: AceTime v1.5

## How to Regenerate

To regenerate this README.md:

```
$ make clean_benchmarks
$ make benchmarks
$ make README.md
```

The `make benchmarks` target uses `collect.sh` script which calls `auniter.sh`
(https://github.com/bxparks/AUniter) to invoke the Arduino IDE programmatically.
It produces a `*.txt` file with the flash and ram usage information (e.g.
`nano.txt`). It now takes about 16 minutes to generate the `*.txt` files on my
quad-core Intel Core i7-3840QM CPU @ 2.80GHz laptop.

The `make README.md` command calls the `generated_readme.py` Python script which
generates this `README.md` file. The ASCII tables below are generated by the
`generate_table.awk` script, which takes each `*.txt` file and converts it to an
ASCII table.

## Library Size Changes

In v1.3, the `BasicZoneManager` and `ExtendedZoneManager` classes were unified
under a new parent interface `ZoneManager`. This seems to have caused the flash
size to increase by around 1200 bytes on the AVR processors (Nano, Pro Micro),
about 500 bytes on a SAMD, about 800 bytes on a ESP8266, 100 bytes on a ESP32,
and 1400 bytes on a Teensy 3.2. The 8-bit processors suffer the most
flash size increase proportional to their limited 32kB limit.

Adding the `ZoneManager` interface simplifies a lot of the complexity with
saving and restoring time zones using the `TimeZoneData` object, and I think it
is worth the extra cost of flash size. The mitigating factor is that
applications targetted towards 8-bit processors will normally have fixed number
of timezones at compile time, so they can avoid using a `ZoneManager`, and avoid
this penalty in flash size.

In v1.4.1+, we removed the `ZoneInfo::transitionBufSize` field from the
`ZoneInfo` struct, which saves 1 byte on 8-bit processors (none on 32-bit
processors due to 4-byte alignment). We save 266 bytes for `BasicZoneManager`
and 386 bytes for `ExtendedZoneManager` when all the zones are loaded into the
zone registry.

Also for v1.4.1+, incorporating zoneName compression causes flash/ram usage to
increase by ~250/120 bytes when using only 1-2 zones, but *decreases* flash
consumption by 1200-2400 bytes when all the zones are loaded into the
`ZoneManager`.

In v1.5+, changing just a single method, `ZoneProcessorCache::getType()`, from a
`virtual` to a non-virtual method saves 250-350 bytes of flash memory when using
a `BasicZoneManager` or an `ExtendedZoneManager` on an 8-bit AVR processor.
Unexpectedly, the flash memory consumption *increases* slightly (~0-50 bytes)
for some ARM processors and the ESP32. Since those processors have far more
flash memory, this seems like a good tradeoff.

Also in v1.5+, changing `BasicZoneProcessor` and `ExtendedZoneProcessor` to be
subclasses of the templatized `BasicZoneProcessorTemplate` and
`ExtendedZoneProcessorTemplate` classes causes reduction of flash consumption by
250-400 bytes for 32-bit processors. Don't know why. (Very little difference for
8-bit AVR). Adding a `BrokerFactory` layer of indirection (to support more
complex ZoneProcessors and Brokers) causes flash memory to go up by 100-200
bytes.

## Arduino Nano

* 16MHz ATmega328P
* Arduino IDE 1.8.13
* Arduino AVR Boards 1.8.3

```
+----------------------------------------------------------------+
| Functionality                     |  flash/  ram |       delta |
|-----------------------------------+--------------+-------------|
| Baseline                          |    448/   10 |     0/    0 |
|-----------------------------------+--------------+-------------|
| LocalDateTime                     |   1648/  123 |  1200/  113 |
| ZonedDateTime                     |   2440/  123 |  1992/  113 |
| Manual ZoneManager                |   2684/  123 |  2236/  113 |
| Basic TimeZone (1 zone)           |   7308/  309 |  6860/  299 |
| Basic TimeZone (2 zones)          |   7920/  313 |  7472/  303 |
| BasicZoneManager (1 zone)         |   8702/  327 |  8254/  317 |
| BasicZoneManager (all zones)      |  21690/  703 | 21242/  693 |
| BasicZoneManager (zones+links)    |  25782/  703 | 25334/  693 |
| Extended TimeZone (1 zone)        |  10012/  343 |  9564/  333 |
| Extended TimeZone (2 zones)       |  10504/  347 | 10056/  337 |
| ExtendedZoneManager (1 zone)      |  11348/  361 | 10900/  351 |
| ExtendedZoneManager (all zones)   |  33422/  845 | 32974/  835 |
| ExtendedZoneManager (zones+links) |  38066/  845 | 37618/  835 |
|-----------------------------------+--------------+-------------|
| SystemClock                       |   5662/  282 |  5214/  272 |
| SystemClock+Basic TimeZone        |  10380/  456 |  9932/  446 |
| SystemClock+Extended TimeZone     |  13314/  490 | 12866/  480 |
+----------------------------------------------------------------+

```

## Sparkfun Pro Micro

* 16 MHz ATmega32U4
* Arduino IDE 1.8.13
* SparkFun AVR Boards 1.1.13

```
+----------------------------------------------------------------+
| Functionality                     |  flash/  ram |       delta |
|-----------------------------------+--------------+-------------|
| Baseline                          |   3464/  150 |     0/    0 |
|-----------------------------------+--------------+-------------|
| LocalDateTime                     |   4772/  263 |  1308/  113 |
| ZonedDateTime                     |   5564/  263 |  2100/  113 |
| Manual ZoneManager                |   5808/  263 |  2344/  113 |
| Basic TimeZone (1 zone)           |  10408/  447 |  6944/  297 |
| Basic TimeZone (2 zones)          |  11022/  453 |  7558/  303 |
| BasicZoneManager (1 zone)         |  11802/  465 |  8338/  315 |
| BasicZoneManager (all zones)      |  24792/  843 | 21328/  693 |
| BasicZoneManager (zones+links)    |  28884/  843 | 25420/  693 |
| Extended TimeZone (1 zone)        |  13112/  481 |  9648/  331 |
| Extended TimeZone (2 zones)       |  13606/  487 | 10142/  337 |
| ExtendedZoneManager (1 zone)      |  14448/  499 | 10984/  349 |
| ExtendedZoneManager (all zones)   |  36522/  983 | 33058/  833 |
| ExtendedZoneManager (zones+links) |  41166/  983 | 37702/  833 |
|-----------------------------------+--------------+-------------|
| SystemClock                       |   8646/  422 |  5182/  272 |
| SystemClock+Basic TimeZone        |  13362/  594 |  9898/  444 |
| SystemClock+Extended TimeZone     |  16296/  628 | 12832/  478 |
+----------------------------------------------------------------+

```

## SAMD21 M0 Mini

* 48 MHz ARM Cortex-M0+
* Arduino IDE 1.8.13
* Sparkfun SAMD Boards 1.8.1

```
+----------------------------------------------------------------+
| Functionality                     |  flash/  ram |       delta |
|-----------------------------------+--------------+-------------|
| Baseline                          |  10064/    0 |     0/    0 |
|-----------------------------------+--------------+-------------|
| LocalDateTime                     |  10920/    0 |   856/    0 |
| ZonedDateTime                     |  11160/    0 |  1096/    0 |
| Manual ZoneManager                |  11176/    0 |  1112/    0 |
| Basic TimeZone (1 zone)           |  15220/    0 |  5156/    0 |
| Basic TimeZone (2 zones)          |  15436/    0 |  5372/    0 |
| BasicZoneManager (1 zone)         |  15964/    0 |  5900/    0 |
| BasicZoneManager (all zones)      |  33508/    0 | 23444/    0 |
| BasicZoneManager (zones+links)    |  39748/    0 | 29684/    0 |
| Extended TimeZone (1 zone)        |  16988/    0 |  6924/    0 |
| Extended TimeZone (2 zones)       |  17236/    0 |  7172/    0 |
| ExtendedZoneManager (1 zone)      |  17700/    0 |  7636/    0 |
| ExtendedZoneManager (all zones)   |  47780/    0 | 37716/    0 |
| ExtendedZoneManager (zones+links) |  54868/    0 | 44804/    0 |
|-----------------------------------+--------------+-------------|
| SystemClock                       |  13264/    0 |  3200/    0 |
| SystemClock+Basic TimeZone        |  16836/    0 |  6772/    0 |
| SystemClock+Extended TimeZone     |  18700/    0 |  8636/    0 |
+----------------------------------------------------------------+

```

(SAMD compiler does not produce RAM usage numbers.)

## STM32 Blue Pill

* STM32F103C8, 72 MHz ARM Cortex-M3
* Arduino IDE 1.8.13
* STM32duino 1.9.0

```
+----------------------------------------------------------------+
| Functionality                     |  flash/  ram |       delta |
|-----------------------------------+--------------+-------------|
| Baseline                          |  19136/ 3788 |     0/    0 |
|-----------------------------------+--------------+-------------|
| LocalDateTime                     |  23128/ 3988 |  3992/  200 |
| ZonedDateTime                     |  23280/ 3988 |  4144/  200 |
| Manual ZoneManager                |  23288/ 3988 |  4152/  200 |
| Basic TimeZone (1 zone)           |  27092/ 3988 |  7956/  200 |
| Basic TimeZone (2 zones)          |  27304/ 3988 |  8168/  200 |
| BasicZoneManager (1 zone)         |  27776/ 3988 |  8640/  200 |
| BasicZoneManager (all zones)      |  45056/ 3988 | 25920/  200 |
| BasicZoneManager (zones+links)    |  51156/ 3988 | 32020/  200 |
| Extended TimeZone (1 zone)        |  28588/ 3988 |  9452/  200 |
| Extended TimeZone (2 zones)       |  28856/ 3988 |  9720/  200 |
| ExtendedZoneManager (1 zone)      |  29272/ 3988 | 10136/  200 |
| ExtendedZoneManager (all zones)   |  58964/ 3988 | 39828/  200 |
| ExtendedZoneManager (zones+links) |     -1/   -1 |    -1/   -1 |
|-----------------------------------+--------------+-------------|
| SystemClock                       |  26004/ 3988 |  6868/  200 |
| SystemClock+Basic TimeZone        |  29596/ 3988 | 10460/  200 |
| SystemClock+Extended TimeZone     |  31196/ 3988 | 12060/  200 |
+----------------------------------------------------------------+

```

An entry of `-1` indicates that the memory usage exceeded the maximum of the
microcontroller and the compiler did not generate the desired information.

(SAMD compiler does not produce RAM usage numbers.)

## ESP8266

* NodeMCU 1.0, 80MHz ESP8266
* Arduino IDE 1.8.13
* ESP8266 Boards 2.7.4

```
+----------------------------------------------------------------+
| Functionality                     |  flash/  ram |       delta |
|-----------------------------------+--------------+-------------|
| Baseline                          | 256700/26776 |     0/    0 |
|-----------------------------------+--------------+-------------|
| LocalDateTime                     | 258820/27264 |  2120/  488 |
| ZonedDateTime                     | 259012/27264 |  2312/  488 |
| Manual ZoneManager                | 259076/27264 |  2376/  488 |
| Basic TimeZone (1 zone)           | 264828/27824 |  8128/ 1048 |
| Basic TimeZone (2 zones)          | 265148/27824 |  8448/ 1048 |
| BasicZoneManager (1 zone)         | 265916/27824 |  9216/ 1048 |
| BasicZoneManager (all zones)      | 283548/27824 | 26848/ 1048 |
| BasicZoneManager (zones+links)    | 289644/27824 | 32944/ 1048 |
| Extended TimeZone (1 zone)        | 266892/27968 | 10192/ 1192 |
| Extended TimeZone (2 zones)       | 267212/27968 | 10512/ 1192 |
| ExtendedZoneManager (1 zone)      | 267932/27968 | 11232/ 1192 |
| ExtendedZoneManager (all zones)   | 298160/27980 | 41460/ 1204 |
| ExtendedZoneManager (zones+links) | 305072/27980 | 48372/ 1204 |
|-----------------------------------+--------------+-------------|
| SystemClock                       | 262268/27276 |  5568/  500 |
| SystemClock+Basic TimeZone        | 267672/27824 | 10972/ 1048 |
| SystemClock+Extended TimeZone     | 269784/27968 | 13084/ 1192 |
+----------------------------------------------------------------+

```

## ESP32

* ESP32-01 Dev Board, 240 MHz Tensilica LX6
* Arduino IDE 1.8.13
* ESP32 Boards 1.0.4

```
+----------------------------------------------------------------+
| Functionality                     |  flash/  ram |       delta |
|-----------------------------------+--------------+-------------|
| Baseline                          | 206435/14564 |     0/    0 |
|-----------------------------------+--------------+-------------|
| LocalDateTime                     | 218385/16124 | 11950/ 1560 |
| ZonedDateTime                     | 218693/16124 | 12258/ 1560 |
| Manual ZoneManager                | 218741/16124 | 12306/ 1560 |
| Basic TimeZone (1 zone)           | 223301/16124 | 16866/ 1560 |
| Basic TimeZone (2 zones)          | 223561/16124 | 17126/ 1560 |
| BasicZoneManager (1 zone)         | 224253/16124 | 17818/ 1560 |
| BasicZoneManager (all zones)      | 241965/16124 | 35530/ 1560 |
| BasicZoneManager (zones+links)    | 248309/16124 | 41874/ 1560 |
| Extended TimeZone (1 zone)        | 225097/16124 | 18662/ 1560 |
| Extended TimeZone (2 zones)       | 225393/16124 | 18958/ 1560 |
| ExtendedZoneManager (1 zone)      | 226125/16124 | 19690/ 1560 |
| ExtendedZoneManager (all zones)   | 256421/16124 | 49986/ 1560 |
| ExtendedZoneManager (zones+links) | 263629/16124 | 57194/ 1560 |
|-----------------------------------+--------------+-------------|
| SystemClock                       | 225973/16228 | 19538/ 1664 |
| SystemClock+Basic TimeZone        | 230161/16228 | 23726/ 1664 |
| SystemClock+Extended TimeZone     | 232041/16228 | 25606/ 1664 |
+----------------------------------------------------------------+

```

RAM usage remains constant as more objects are created, which indicates that an
initial pool of a certain minimum size is created regardless of the actual RAM
usage by objects.

## Teensy 3.2

* 96 MHz ARM Cortex-M4
* Arduino IDE 1.8.13
* Teensyduino 1.53

```
+----------------------------------------------------------------+
| Functionality                     |  flash/  ram |       delta |
|-----------------------------------+--------------+-------------|
| Baseline                          |   7624/ 3048 |     0/    0 |
|-----------------------------------+--------------+-------------|
| LocalDateTime                     |  13268/ 4812 |  5644/ 1764 |
| ZonedDateTime                     |  13268/ 4812 |  5644/ 1764 |
| Manual ZoneManager                |  13268/ 4812 |  5644/ 1764 |
| Basic TimeZone (1 zone)           |  22392/ 4812 | 14768/ 1764 |
| Basic TimeZone (2 zones)          |  23120/ 4812 | 15496/ 1764 |
| BasicZoneManager (1 zone)         |  23904/ 4812 | 16280/ 1764 |
| BasicZoneManager (all zones)      |  41648/ 4812 | 34024/ 1764 |
| BasicZoneManager (zones+links)    |  47992/ 4812 | 40368/ 1764 |
| Extended TimeZone (1 zone)        |  23908/ 4812 | 16284/ 1764 |
| Extended TimeZone (2 zones)       |  24636/ 4812 | 17012/ 1764 |
| ExtendedZoneManager (1 zone)      |  25420/ 4812 | 17796/ 1764 |
| ExtendedZoneManager (all zones)   |  55716/ 4812 | 48092/ 1764 |
| ExtendedZoneManager (zones+links) |  62924/ 4812 | 55300/ 1764 |
|-----------------------------------+--------------+-------------|
| SystemClock                       |  16192/ 4812 |  8568/ 1764 |
| SystemClock+Basic TimeZone        |  25500/ 4812 | 17876/ 1764 |
| SystemClock+Extended TimeZone     |  27016/ 4812 | 19392/ 1764 |
+----------------------------------------------------------------+

```

